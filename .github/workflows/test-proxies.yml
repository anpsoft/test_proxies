# test-proxies.yml
 
name: Test Proxies
 
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'in/**'
      - 'option.ini'
      - 'test_proxies.py'
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

jobs:
  test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # –î–æ–±–∞–≤–ª—è–µ–º permission –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests urllib3
          pip install requests urllib3 PySocks  
      
      - name: Download sing-box
        run: |
          SINGBOX_VERSION="1.10.6"
          wget -q "https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
          tar -xzf "sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
          mv "sing-box-${SINGBOX_VERSION}-linux-amd64/sing-box" ./sing-box
          chmod +x ./sing-box
          ./sing-box version
      
      - name: Create directories
        run: |
          mkdir -p in out
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ in –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          if [ -d "in" ] && [ "$(ls -A in)" ]; then
            echo "–§–∞–π–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã"
          else
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ in –ø—É—Å—Ç–∞, —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä"
            echo "vless://uuid@example.com:443?security=tls&sni=example.com#–ü—Ä–∏–º–µ—Ä" > in/example.txt
          fi
      
      - name: Run proxy tests
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # python test_proxies.py
          # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–±–∞–≥
          export DEBUG=1
          python test_proxies.py 2>&1 | head -100  # –ü–æ–∫–∞–∂–∏ –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞

      
      
      - name: Upload results to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: out/
          retention-days: 7
      
      - name: Commit and push results
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ out/
          git add out/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if git diff --cached --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            echo "–ö–æ–º–º–∏—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
            git commit -m "ü§ñ Auto-update: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏ [skip ci]"
            git push
          fi
